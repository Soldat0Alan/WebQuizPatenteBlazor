@using Patente
@using System.Linq
@using System.Globalization
@using System.Reflection.Metadata

@inject Bit.Butil.Document document
@inject Microsoft.JSInterop.IJSRuntime js
@rendermode InteractiveServer

        <div class="card container p-3 mx-auto justify-content-center container-fluid " style="width:1920px; height:720px; position: relative; ">
            
            @if(Time != "00:00")
            {
        
                 @if(_indice < domandeSchedaQuiz.Count){
                
                <div class="progress mb-4">
                    <div class="progress-bar progress-bar-striped bg-success" role="progressbar" style="width: @_lunghezzaBarraAvanzamento.ToString(CultureInfo.InvariantCulture)%" aria-valuenow="@_lunghezzaBarraAvanzamento.ToString(CultureInfo.InvariantCulture)" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                
                <div class="row">
                    <div class="col">
                        <img src="/images/@(domandeSchedaQuiz[_indice].Immagine.ToString("000")).gif" class="card card-img-top" alt="Immagine quiz">                
                    </div>

                    <div class=" col">
                        <div class="btn-group w-100 mb-2">
                            <button type="button" class="btn btn-outline-dark  @(indiceBtnRangeSelezionato == 0 ? "btn-dark text-light"  : "btn-outline-dark text-dark")" @onclick="()  => CambiaRangeQuiz(RangeQuiz.Uno_Dieci)">1-10 </button>
                            <button type="button" class="btn btn-outline-dark @(indiceBtnRangeSelezionato == 1 ? "btn-dark text-light" : "btn-outline-dark text-dark")" @onclick="() => CambiaRangeQuiz(RangeQuiz.Undici_Venti)">11-20</button>
                            <button type="button" class="btn btn-outline-dark @(indiceBtnRangeSelezionato == 2 ? "btn-dark text-light" : "btn-outline-dark text-dark")" @onclick="() => CambiaRangeQuiz(RangeQuiz.Ventuno_Trenta)">21-30</button>
                        </div>
                       
                        <div class="btn-toolbar mb-3 d-flex justify-content-center" role="toolbar">
                        
                            <div class="btn-group me-2" role="group">
                                @for(int i=0; i<10;i++)
                                {
                                    int indiceCorrente = i;
                                    
                                    <button type="button" class="btn btn-outline-secondary @(indiceBtnSelezionato == indiceCorrente ? "btn-secondary" : "btn-outline-secondary")" @onclick="() => VaiADomandaSpecifica(indiceCorrente+numDomandaIniziale)">@(numDomandaIniziale+indiceCorrente)</button>
                                }
                            </div>
                        </div>
                        <hr>
                        <h1 class="text-center mb-2">@Time</h1> 
                        <h4 class="card-title text-center ">Domanda @(_indice + 1) di @domandeSchedaQuiz.Count</h4>
                        <div class="card-body">     
                            <p class="card-text text-center">@domandeSchedaQuiz[_indice].DomandaQuiz</p>
                            
                           <div class="d-flex justify-content-center gap-3" style="position: absolute; bottom: 200px; left: 65%;">
                                <button class="p-0 border-0 bg-transparent "  @onclick="() => TornaAlPrecedente()"><i class="bi bi-arrow-left fs-3"></i></button>
                                <button class="btn btn-outline-success btn-lg px-4 " @onclick="() => VaiAlProssimo()">Vero</button>
                                <button class="btn btn-outline-danger btn-lg px-4" @onclick="() => VaiAlProssimo()">Falso</button>
                                <button class="p-0 border-0 bg-transparent" @onclick="() => VaiAlProssimo()"><i class="bi bi-arrow-right fs-3"></i></button>
                            </div>      
                    </div>
                </div>
                </div>      
                
                }

                
            }

        </div>

@code {

    [Parameter] public int IdCapitolo { get; set; }
    [Parameter] public List<Domanda> ListaDomande { get; set; }
    [Parameter] public List<Suggerimento> listaSuggerimenti { get; set; }
    private List<Domanda> domandeSchedaQuiz = new List<Domanda>();
    private List<Suggerimento> suggerimentiCorrenti;
    private int _indice = 0;
    private decimal _lunghezzaBarraAvanzamento =3.34m; 
    RangeQuiz rangeQuizAttuale= RangeQuiz.Uno_Dieci;
    int numDomandaIniziale =1;

    //Serve per fare in modo che al click del bottone rimanga evidenziato il bottone cliccato.
    int indiceBtnSelezionato = 0; 
    int indiceBtnRangeSelezionato = 0; 

    //Per timer
    
    private System.Threading.Timer? _quizTimer;
    private int _remainingSeconds = 1800;
    string Time { get; set; } = "00:00";

    private void StartTimer()
    {
        _quizTimer = new System.Threading.Timer(_ =>
        {
            InvokeAsync(() =>
            {
                _remainingSeconds--;
                if (_remainingSeconds <= 0) _quizTimer?.Dispose();
                  Time = TimeSpan.FromSeconds(_remainingSeconds).ToString(@"mm\:ss");
                StateHasChanged();
            });
        }, null, 1000, 1000);
    }

    private void PauseTimer() => _quizTimer?.Change(Timeout.Infinite, Timeout.Infinite);
    private void ResumeTimer() => _quizTimer?.Change(0, 1000);

    protected override async Task OnInitializedAsync()
    {
        
    }

    protected override void OnParametersSet()
    {
        IEnumerable<Domanda>? tutteDomandeCapitolo = ListaDomande.Where(d => d.Id_Capitolo == IdCapitolo);

        domandeSchedaQuiz = tutteDomandeCapitolo.OrderBy(x => Guid.NewGuid()).Take(30).ToList();
        _indice = 0;
        
    }


    public void VaiAlProssimo()
    {
        if(_indice<=29)
        {
            VaiADomandaSpecifica(_indice+2);

            _lunghezzaBarraAvanzamento  += 3.34m;
            AggiornaBarra();
        }
    }

    public void TornaAlPrecedente()
    {
        if(_indice>=1)
        {
            VaiADomandaSpecifica(_indice);
            _lunghezzaBarraAvanzamento  -= 3.34m;
            AggiornaBarra();
        }
    }

    public void VaiADomandaSpecifica(int i)
    {
        _indice = i-1;
        indiceBtnSelezionato=_indice;
        Console.WriteLine(indiceBtnSelezionato);

        if(indiceBtnSelezionato >=0 && indiceBtnSelezionato <=9 )
        {
            CambiaRangeQuiz(RangeQuiz.Uno_Dieci);
        }else if (indiceBtnSelezionato >9 && indiceBtnSelezionato <=19)
        {
            CambiaRangeQuiz(RangeQuiz.Undici_Venti);
        }else{
            CambiaRangeQuiz(RangeQuiz.Ventuno_Trenta);
        }
        AggiornaBarra();
    }

    public void CambiaRangeQuiz(RangeQuiz rangeQuiz)
    {
        rangeQuizAttuale = rangeQuiz;
        if(rangeQuiz == RangeQuiz.Uno_Dieci)
        {
            numDomandaIniziale=1;
            indiceBtnRangeSelezionato=0;
        }else if(rangeQuiz == RangeQuiz.Undici_Venti)
        {
            numDomandaIniziale=11;
            indiceBtnRangeSelezionato=1;
        }else if(rangeQuiz == RangeQuiz.Ventuno_Trenta)
        {
            numDomandaIniziale=21;
            indiceBtnRangeSelezionato=2;
        }
        indiceBtnSelezionato=-1;
    }

    public void AggiornaBarra()
    {
        _lunghezzaBarraAvanzamento = (_indice+1) * 3.34m;  
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            StartTimer();

            await document.AddEventListener<object>("visibilitychange", (args) => _ = OnVisibilityChange(args));  
                    
        }
    }

    private async Task OnVisibilityChange(object args)
    {
        var isHidden = await js.InvokeAsync<bool>("eval", "document.hidden");
        if (isHidden)
        {
            Console.WriteLine("Timer fermo!");
            PauseTimer();
        }
        else
        {
            Console.WriteLine("Timer ripreso!");
            ResumeTimer();
        }
    }
}
